<html>
<head>
    <title>Fono V3</title>
</head>

<body>
<div>
    <h1 id="id_status">Fonocardio</h1>
    <label style="font-size: 160%;padding-right: 20px;">Numero de segundos</label>
    <input id="id_buffers" style = "font-size: 160%; background-color:bisque;" type="number" value="1" min="1" max="10">
    <svg id="id_info" version="1.0" xmlns="http://www.w3.org/2000/svg"
         width="25px" height="25px" viewBox="0 0 626.000000 626.000000"
         preserveAspectRatio="xMidYMid meet"style= "float: right; margin: 0 0 0 15px;">

        <g transform="translate(0.000000,626.000000) scale(0.100000,-0.100000)"
           fill="#000000" stroke="none">
            <path d="M2890 5964 c-344 -32 -675 -122 -975 -264 -103 -49 -314 -166 -325
                    -180 -3 -4 -16 -13 -29 -20 -13 -6 -43 -26 -66 -44 -23 -17 -55 -40 -71 -51
                    -155 -109 -460 -415 -569 -569 -11 -16 -34 -48 -51 -71 -18 -23 -38 -53 -44
                    -66 -7 -13 -16 -26 -20 -29 -14 -11 -137 -231 -182 -329 -120 -256 -202 -530
                    -245 -821 -28 -190 -25 -613 5 -808 43 -279 121 -538 235 -783 50 -108 163
                    -308 216 -384 19 -27 45 -66 58 -85 120 -177 461 -517 638 -636 28 -18 68 -46
                    90 -62 66 -47 272 -162 374 -209 253 -118 521 -197 811 -240 191 -28 613 -25
                    808 5 438 68 811 214 1187 465 311 208 621 536 824 872 206 340 328 683 388
                    1085 26 177 26 602 0 780 -43 290 -122 558 -240 811 -47 102 -162 308 -209
                    374 -16 22 -44 63 -62 90 -89 133 -329 388 -491 522 -109 90 -105 87 -230 174
                    -77 54 -277 167 -384 216 -242 113 -502 191 -776 234 -97 15 -192 21 -375 24
                    -135 1 -265 1 -290 -1z m652 -1113 c116 -45 219 -148 254 -253 35 -108 16
                    -252 -47 -344 -53 -77 -153 -146 -251 -173 -76 -21 -221 -11 -289 21 -81 37
                    -137 81 -186 146 -57 76 -76 144 -71 249 9 174 119 303 313 369 60 21 206 13
                    277 -15z m-424 -1166 c115 -19 200 -57 273 -123 168 -152 177 -380 35 -867
                    -145 -492 -197 -731 -182 -827 11 -70 41 -114 93 -139 42 -21 62 -24 153 -23
                    86 1 120 6 188 28 46 15 85 26 87 24 2 -2 -7 -45 -19 -97 l-23 -94 -74 -29
                    c-309 -121 -368 -136 -539 -145 -203 -9 -351 34 -464 138 -121 110 -154 236
                    -125 474 13 103 38 206 142 575 117 410 142 538 127 636 -14 84 -37 120 -93
                    144 -44 19 -64 22 -156 18 -75 -3 -128 -11 -179 -27 -40 -13 -75 -22 -77 -19
                    -3 3 4 46 15 95 21 88 22 91 58 106 181 78 376 137 522 160 57 9 151 6 238 -8z"/>
        </g>
    </svg>

    <svg version="1.0" xmlns="http://www.w3.org/2000/svg"
         width="200px" height="200px" viewBox="0 0 866.000000 650.000000"
         preserveAspectRatio="xMidYMid meet" style= "float: right; margin: 0 0 0 15px;">

        <g transform="translate(0.000000,650.000000) scale(0.100000,-0.100000)"
           fill="#000000" stroke="none">
            <path d="M3632 5306 c-123 -31 -252 -125 -330 -244 l-28 -42 -64 138 c-35 75
                        -68 140 -74 144 -15 10 -898 10 -913 0 -11 -7 -198 -419 -648 -1422 -45 -102
                        -182 -407 -304 -677 -121 -271 -221 -495 -221 -498 0 -3 209 -5 464 -5 l463 0
                        209 463 c114 254 263 586 332 737 68 151 134 297 146 324 l22 49 62 -135 63
                        -136 -280 -631 c-154 -346 -282 -639 -286 -651 -6 -20 -5 -20 445 -20 l452 0
                        31 72 c18 40 48 106 67 147 l36 74 33 -51 c44 -68 144 -161 211 -194 117 -58
                        127 -59 773 -61 654 -2 648 -3 771 61 83 43 162 113 212 189 l38 57 36 -74
                        c19 -41 50 -108 68 -147 l32 -73 456 0 c430 0 456 1 452 18 -3 9 -134 303
                        -292 653 l-286 636 63 134 63 133 28 -65 c16 -35 141 -314 278 -619 137 -305
                        279 -620 315 -700 35 -80 71 -155 79 -167 l14 -23 460 0 c253 0 460 4 460 9 0
                        7 -86 201 -245 551 -39 87 -414 920 -769 1709 -80 179 -152 328 -159 333 -6 4
                        -213 8 -458 8 -412 0 -447 -1 -461 -17 -8 -10 -39 -70 -68 -133 -71 -156 -63
                        -148 -88 -105 -61 102 -171 194 -287 237 -60 23 -64 23 -690 25 -488 1 -642
                        -1 -683 -11z m-133 -1101 c241 -528 445 -975 455 -993 65 -123 253 -203 413
                        -173 112 21 206 81 260 168 17 26 90 180 164 340 74 161 136 293 139 293 3 0
                        72 -148 153 -329 l149 -329 -35 -76 c-48 -103 -119 -177 -217 -224 l-75 -36
                        -270 -9 c-326 -11 -858 -3 -935 14 -130 28 -229 108 -294 237 -19 39 -82 171
                        -140 294 -57 123 -157 336 -221 473 -64 138 -130 277 -145 310 -15 33 -112
                        240 -215 460 -103 220 -202 433 -221 473 l-33 72 315 -2 316 -3 437 -960z
                        m2661 961 c0 -1 -65 -142 -145 -312 -80 -170 -182 -389 -228 -486 -45 -97 -84
                        -177 -87 -177 -3 -1 -74 149 -158 333 l-153 334 72 156 73 156 313 0 c172 0
                        313 -2 313 -4z m-1750 -299 c24 -12 56 -38 71 -57 15 -19 72 -134 127 -255 55
                        -121 128 -279 162 -350 85 -180 86 -171 -35 -420 -53 -110 -126 -265 -161
                        -344 -77 -172 -100 -206 -168 -237 -104 -48 -233 -24 -297 56 -33 42 -361 736
                        -361 765 0 17 263 609 328 737 26 51 75 96 126 115 58 21 159 16 208 -10z"/>
            <path d="M6617 2173 c-4 -3 -7 -169 -7 -368 0 -401 0 -399 60 -393 l35 3 3
                        360 c1 198 0 370 -3 383 -4 18 -12 22 -44 22 -21 0 -41 -3 -44 -7z"/>
            <path d="M865 1993 c-135 -319 -179 -421 -205 -478 -50 -109 -50 -107 11 -103
                        l53 3 36 85 36 85 179 0 179 0 36 -85 36 -85 52 -3 c29 -2 52 1 52 6 0 5 -41
                        105 -91 223 -50 118 -113 268 -141 334 -28 66 -58 128 -66 138 -10 12 -30 17
                        -62 17 l-46 0 -59 -137z m184 -139 c44 -109 64 -171 57 -174 -6 -3 -70 -3
                        -143 0 l-131 5 62 155 c35 85 66 164 70 174 3 10 9 17 11 14 3 -3 36 -81 74
                        -174z"/>
            <path d="M4893 2068 c-18 -8 -23 -20 -23 -47 0 -70 -8 -81 -54 -81 -59 0 -71
                        -11 -67 -62 1 -14 13 -18 59 -20 l57 -3 5 -191 c5 -174 7 -194 25 -214 32 -36
                        70 -50 133 -50 65 0 82 11 82 53 0 29 0 29 -45 23 -41 -7 -48 -5 -75 23 l-30
                        29 0 166 0 165 68 3 c66 3 67 4 70 32 5 37 -10 46 -80 46 l-58 0 0 70 c0 66
                        -1 70 -22 69 -13 0 -33 -5 -45 -11z"/>
            <path d="M2272 1932 c-102 -37 -162 -120 -170 -237 -6 -97 22 -168 88 -228 55
                        -50 103 -67 186 -67 101 0 115 9 107 66 l-5 31 -52 -15 c-68 -19 -128 -4 -173
                        44 -77 82 -69 235 16 307 47 39 80 44 186 25 17 -2 21 3 23 33 4 43 -5 48 -93
                        55 -43 3 -75 -1 -113 -14z"/>
            <path d="M2805 1937 c-70 -23 -85 -35 -85 -67 0 -40 11 -43 65 -19 37 16 62
                        20 107 17 74 -5 110 -36 112 -94 l1 -39 -100 -6 c-55 -3 -112 -11 -128 -17
                        -138 -58 -159 -231 -34 -291 75 -36 187 -25 247 25 l30 26 0 -31 c0 -30 2 -31
                        43 -31 l42 0 -3 188 c-1 103 -5 201 -8 219 -6 38 -45 88 -86 109 -41 21 -154
                        27 -203 11z m199 -330 c-1 -117 -142 -181 -216 -97 -70 77 5 152 147 147 l70
                        -2 -1 -48z"/>
            <path d="M3567 1936 c-20 -7 -52 -25 -71 -40 l-35 -26 -3 32 c-3 31 -5 33 -43
                        33 l-40 0 0 -370 0 -370 40 0 40 0 5 143 5 144 25 -27 c35 -38 80 -55 147 -55
                        114 1 182 59 220 190 20 69 8 177 -29 248 -45 87 -167 133 -261 98z m123 -88
                        c51 -35 73 -88 73 -172 0 -140 -85 -230 -187 -196 -75 25 -123 117 -113 218
                        14 137 132 214 227 150z"/>
            <path d="M4261 1940 c-115 -24 -191 -117 -199 -245 -6 -97 22 -168 88 -228 55
                        -50 103 -67 186 -67 98 1 186 57 230 148 27 55 31 169 8 233 -43 120 -176 187
                        -313 159z m136 -86 c53 -26 93 -103 93 -179 -1 -139 -93 -226 -206 -195 -98
                        28 -150 159 -110 273 36 99 133 143 223 101z"/>
            <path d="M6045 1936 c-72 -23 -85 -33 -85 -71 0 -19 2 -35 4 -35 2 0 23 9 47
                        20 52 23 138 26 178 5 28 -14 48 -49 53 -95 3 -25 3 -25 -97 -30 -117 -6 -186
                        -33 -222 -89 -32 -47 -31 -125 0 -172 30 -45 68 -62 148 -67 68 -4 128 15 158
                        52 17 20 31 11 31 -20 0 -21 4 -24 40 -24 l40 0 0 188 c0 106 -5 204 -11 227
                        -28 99 -159 150 -284 111z m197 -324 c-4 -65 -27 -101 -79 -124 -81 -36 -163
                        2 -163 75 0 65 58 97 170 94 l75 -2 -3 -43z"/>
            <path d="M7120 1935 c-134 -43 -212 -213 -165 -356 23 -68 101 -149 161 -167
                        50 -14 153 -16 188 -2 26 10 34 38 20 73 -5 14 -10 14 -47 1 -85 -31 -170 5
                        -211 88 -40 81 -33 164 22 237 36 48 83 65 165 58 l67 -6 0 34 c0 39 -10 44
                        -95 51 -37 2 -77 -2 -105 -11z"/>
            <path d="M7680 1935 c-106 -34 -174 -136 -174 -259 0 -164 107 -276 264 -276
                        157 0 262 108 264 270 1 123 -53 214 -152 256 -54 22 -148 27 -202 9z m154
                        -79 c46 -19 84 -73 98 -139 29 -137 -74 -268 -189 -241 -75 18 -113 61 -133
                        149 -35 158 89 287 224 231z"/>
            <path d="M1523 1933 c-7 -2 -13 -20 -13 -39 l0 -34 140 0 c77 0 140 -3 140 -6
                        0 -3 -65 -83 -145 -177 -99 -117 -147 -182 -151 -204 -12 -65 -16 -64 213 -61
                        l208 3 3 29 c2 16 -2 32 -8 36 -6 4 -72 6 -146 6 -74 -1 -139 1 -145 5 -9 5
                        126 176 237 301 35 39 59 105 48 132 -5 14 -30 16 -188 15 -99 0 -187 -3 -193
                        -6z"/>
            <path d="M5313 1933 c-7 -2 -13 -20 -13 -39 l0 -33 142 -3 142 -3 -129 -154
                        c-174 -205 -168 -197 -169 -245 l-1 -41 210 0 210 0 3 24 c2 13 -1 28 -6 33
                        -6 6 -67 10 -144 9 -73 -1 -139 3 -146 7 -10 7 12 40 89 133 56 68 119 143
                        140 166 21 22 43 60 49 83 18 69 14 70 -189 69 -97 0 -182 -3 -188 -6z"/>
        </g>
    </svg>

</div>

<div style="padding-top: 20px;">
    <label style="font-size: 160%; padding-right: 20px;">Nombre del archivo</label>
    <input id="id_nameFile" style = "font-size: 160%; background-color: bisque;" type="text" value="demo">
    <button id="id_saveFile"  style = "font-size: 160%;" onclick="saveFile()" >Guardar</button>
</div>

<div style="padding-top: 20px;">
    <label style="font-size: 160% ">Capacidad del archivo</label>
    <label id="id_sizeFile" style="font-size: 160%; padding-left:20px; padding-right: 20px; background-color: cyan; border: 1px solid rgb(0, 0, 0);">0KB</label>
    <button id="id_saveFile"  style = "font-size: 160%" onclick="clearFile()" >Limpiar</button>
</div>

<div style="width: 100%; height: 100%;">
    <canvas class="plotFonocardio"></canvas>
</div>

<script>
            let canvas = document.querySelector(".plotFonocardio");
            let status = document.getElementById('id_status');
            let inputElem = document.getElementById('id_buffers');
            let ip_address = window.location.hostname;
            let webSocket = new WebSocket("ws://" + ip_address + ":8080/");
            console.log("Mario was Here");
            console.log("Fonocardiograma V3");
            console.log("Closer P.");

            let numBuffers = 1;
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight-100;
            canvas.lineWidth = 0.5;
            canvas.data = [];
            canvas.allData = [];

            window.addEventListener('resize', function(event){
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight-100;
            })

            inputElem.addEventListener('input', () => {
                numBuffers = parseInt(inputElem.value)
            });

            document.getElementById('id_info').addEventListener('click', function (event) {
                window.alert("Fonocardiograma V3\nMario A.P.H \nCloser P.");
            });


            webSocket.onopen = function(frame) {
                status.innerText = "Conectado " + ip_address + ":8080";
                console.log("Connected to: " + ip_address + ":8080")
            };

            webSocket.onmessage = function(frame) {
                plotData(JSON.parse(frame.data));
                return false
            };

            webSocket.onclose = function(frame) {
                status.innerText = "Socket desconectado";
                console.log("Socket disconnected ")
            };



            function plotData(data) {
                let ctx = canvas.getContext("2d");
                canvas.data.push(data);
                canvas.allData.push(data);
                while(canvas.data.length>numBuffers){
                    canvas.data.shift();
                }

                let dataMap = mapCanvas(canvas.data.flat(1),canvas.width, canvas.height);
                window.data = canvas.data;
                clearCanvas();
                window.dataMap = dataMap;
                ctx.beginPath();
                ctx.strokeStyle = "white";
                ctx.lineWidth = canvas.lineWidth;
                dataMap.forEach(function insertElement(currentValue, index, array){
                    let X = currentValue[0];
                    let Y = currentValue[1];
                    ctx.lineTo(X, Y);
                });
                ctx.stroke();
                getFileSize();
            }


            function getFileSize(){
                let sizeLabel = document.getElementById('id_sizeFile');
                let size = canvas.allData.flat(1).length/1024*4;
                size = size.toPrecision(4);
                sizeLabel.innerText = size + "KB";
            }


            function mapCanvas(array,maxX, maxY){
                let values = [];
                let maxXOld = array.length;
                let maxYOld = 1200;

                for(let index=0; index<array.length; index++){
                    let Y = (maxYOld-array[index])*maxY/maxYOld;
                    let X =                (index)*maxX/maxXOld;
                    values.push([X,Y]);
                }
                return values;
            }


            function clearCanvas() {
                let ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(0,0,0)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(0,0,0)';

                for(let i=1; i<5; i++){
                    ctx.beginPath();
                    ctx.strokeStyle = "white";
                    ctx.moveTo(0,  i*canvas.height/5);
                    ctx.lineTo(canvas.width, i*canvas.height/5);
                    ctx.lineWidth = 0.6;
                    ctx.stroke();
                }

                ctx.beginPath();
                ctx.strokeStyle = "#9B9B9B";
                ctx.moveTo(0,0);
                ctx.lineTo(0,canvas.height);
                ctx.lineTo(canvas.width,canvas.height);
                ctx.lineTo(canvas.width,0);
                ctx.lineTo(0,0);
                ctx.lineWidth = 5;
                ctx.stroke();
            }



            function saveFile(){
            let datos = JSON.stringify(canvas.allData);
            datos = datos.replaceAll(',','\n');
            datos = datos.replaceAll('[','');
            datos = datos.replaceAll(']','');
            let blob = new Blob([datos], {type: "text/txt"});
            window.blob = blob

            let url = window.URL.createObjectURL(blob);
            let anchor = document.createElement("a");
            anchor.href = url;

            let nameFile = document.getElementById('id_nameFile').value;
            if(nameFile.length==0)
                anchor.download = "demo.txt";
            else
                anchor.download = (nameFile + ".txt");

            anchor.click();
            window.URL.revokeObjectURL(url);
            anchor.remove();
            }


            function clearFile(){
                clearCanvas();
                canvas.data = [];
                canvas.allData = [];
            }

            </script>
</body>
</html>
